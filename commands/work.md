# /polyglot:work 命令

使用隔离的 git worktree 系统执行实施计划，持续进行质量验证。

## 用法

```
/polyglot:work [计划引用或内联指令]
```

## 流程

### 阶段1：准备

1. **加载计划**
   - 加载指定的计划
   - 验证所有任务清晰
   - 检查阻塞依赖

2. **环境准备**
   ```bash
   # 创建功能分支
   git checkout -b feature/<计划名称>

   # 可选：创建隔离 worktree
   git worktree add ../worktree-<计划名称> -b feature/<计划名称>
   ```

3. **依赖安装**
   - 安装计划中指定的新依赖
   - 验证构建在开始前通过

### 阶段2：执行循环

对计划中的每个任务：

1. **预实现**
   - 阅读相关现有代码
   - 理解上下文
   - 规划具体变更

2. **实现**
   - 遵循项目模式编写代码
   - 添加/更新类型和接口
   - 遵循语言特定最佳实践

3. **测试**
   - 为新代码编写单元测试
   - 必要时更新现有测试
   - 运行完整测试套件

4. **验证**
   ```bash
   # TypeScript
   npm run lint && npm run type-check && npm test

   # Python
   ruff check . && mypy . && pytest

   # Java
   ./mvnw verify
   ```

5. **提交**
   ```bash
   git add <文件>
   git commit -m "feat(<范围>): <描述>"
   ```

### 阶段3：完成

1. **最终验证**
   - 运行所有测试
   - 构建项目
   - 检查回归问题

2. **清理**
   ```bash
   # 如果使用 worktree
   cd ..
   git worktree remove worktree-<计划名称>
   ```

3. **准备审查**
   - 推送分支到远程
   - 如配置则创建草稿 PR

## 执行模式

### 标准模式
顺序执行所有任务并验证。

### 并行模式
并行执行独立任务（谨慎使用）。

### 步进模式
逐任务执行，任务间需要确认。

## 输出格式

```markdown
# 工作会话报告

## 计划：[计划名称]
**分支**：feature/<名称>
**开始时间**：[时间戳]
**完成时间**：[时间戳]

## 任务进度

### 任务1：[名称]
- **状态**：完成 ✓
- **变更文件**：
  - `src/file.ts` - 添加新函数
  - `tests/file.test.ts` - 添加测试
- **提交**：abc1234
- **备注**：相关观察

### 任务2：[名称]
- **状态**：完成 ✓
...

## 质量指标
- 测试：全部通过 (50/50)
- Lint：无问题
- 类型检查：无错误
- 构建：成功

## 提交记录
| 哈希 | 消息 |
|------|------|
| abc1234 | feat(auth): 添加登录端点 |
| def5678 | test(auth): 添加登录测试 |

## 后续步骤
- [ ] 推送到远程：`git push -u origin feature/<名称>`
- [ ] 创建 PR 审查
- [ ] 运行 /polyglot:review 代码审查
```

## 错误处理

### 测试失败
```markdown
## 任务阻塞：测试失败

**任务**：任务名称
**错误**：
```
错误消息
```

**尝试的修复**：
1. 尝试 X
2. 尝试 Y

**建议**：[下一步建议]
```

### 构建失败
```markdown
## 任务阻塞：构建失败

**错误类型**：[类型/编译等]
**错误**：
```
错误消息
```

**可能原因**：分析
**建议修复**：建议
```

## Git Worktree 使用

复杂工作时使用隔离环境：

```bash
# 创建 worktree
git worktree add ../feature-workspace -b feature/my-feature

# 在隔离环境中工作
cd ../feature-workspace

# 完成工作后返回
cd ../main-repo
git worktree remove ../feature-workspace
```

优点：
- 干净的工作目录
- 需要时易于放弃
- 可并行开发多个功能

## 最佳实践

1. **原子提交**：每个提交一个逻辑变更
2. **测试先行**：与代码同步或先于代码编写测试
3. **频繁验证**：每次变更后运行测试
4. **小步前进**：将大变更分解为小提交
5. **清晰历史**：使用有意义的提交消息
